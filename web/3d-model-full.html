<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>625 Ocean Street — Full 3-Story 3D Rendering</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=DM+Sans:wght@300;400;500&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: #0a0a0a;
    font-family: 'DM Sans', sans-serif;
    overflow: hidden;
    color: #fff;
  }

  canvas { display: block; }

  .overlay-top {
    position: fixed;
    top: 0; left: 0; right: 0;
    padding: 20px 28px;
    background: linear-gradient(180deg, rgba(0,0,0,0.75) 0%, transparent 100%);
    z-index: 10;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    pointer-events: none;
  }

  .title-block h1 {
    font-family: 'Playfair Display', serif;
    font-size: 26px;
    font-weight: 700;
    color: #fff;
    text-shadow: 0 2px 20px rgba(0,0,0,0.5);
  }

  .title-block p {
    font-size: 12px;
    color: rgba(255,255,255,0.55);
    margin-top: 3px;
    letter-spacing: 2.5px;
    text-transform: uppercase;
  }

  .stats {
    display: flex;
    gap: 20px;
  }

  .stat-value {
    font-family: 'Playfair Display', serif;
    font-size: 20px;
    font-weight: 700;
    color: #c9a96e;
    text-align: right;
  }

  .stat-label {
    font-size: 9px;
    color: rgba(255,255,255,0.45);
    letter-spacing: 2px;
    text-transform: uppercase;
    text-align: right;
  }

  .overlay-bottom {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    padding: 16px 28px;
    background: linear-gradient(0deg, rgba(0,0,0,0.75) 0%, transparent 100%);
    z-index: 10;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    pointer-events: none;
  }

  .controls-hint {
    font-size: 11px;
    color: rgba(255,255,255,0.35);
    line-height: 1.8;
  }

  .controls-hint kbd {
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 3px;
    padding: 1px 6px;
    font-family: 'DM Sans', sans-serif;
    font-size: 10px;
  }

  .btn-group {
    display: flex;
    gap: 6px;
    pointer-events: all;
    flex-wrap: wrap;
    justify-content: flex-end;
    max-width: 500px;
  }

  .view-btn {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.12);
    color: rgba(255,255,255,0.6);
    padding: 7px 14px;
    border-radius: 5px;
    font-family: 'DM Sans', sans-serif;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.3s;
    letter-spacing: 0.8px;
    text-transform: uppercase;
  }

  .view-btn:hover, .view-btn.active {
    background: rgba(201,169,110,0.15);
    border-color: #c9a96e;
    color: #c9a96e;
  }

  .floor-toggle {
    pointer-events: all;
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-top: 8px;
  }

  .floor-btn {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.12);
    color: rgba(255,255,255,0.6);
    padding: 6px 12px;
    border-radius: 4px;
    font-family: 'DM Sans', sans-serif;
    font-size: 10px;
    cursor: pointer;
    transition: all 0.3s;
    letter-spacing: 0.8px;
    text-transform: uppercase;
    text-align: left;
  }

  .floor-btn:hover, .floor-btn.active {
    background: rgba(201,169,110,0.15);
    border-color: #c9a96e;
    color: #c9a96e;
  }

  .side-panel {
    position: fixed;
    left: 20px;
    top: 50%;
    transform: translateY(-50%);
    z-index: 10;
    pointer-events: none;
  }

  .toggle-row {
    pointer-events: all;
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
  }

  .toggle-row label {
    font-size: 10px;
    color: rgba(255,255,255,0.45);
    letter-spacing: 1px;
    text-transform: uppercase;
    cursor: pointer;
    min-width: 40px;
  }

  .toggle-switch {
    width: 36px;
    height: 18px;
    background: rgba(255,255,255,0.08);
    border-radius: 9px;
    position: relative;
    cursor: pointer;
    border: 1px solid rgba(255,255,255,0.12);
    transition: all 0.3s;
  }

  .toggle-switch::after {
    content: '';
    width: 14px;
    height: 14px;
    background: #c9a96e;
    border-radius: 50%;
    position: absolute;
    top: 1px;
    left: 1px;
    transition: all 0.3s;
  }

  .toggle-switch.on::after { left: 19px; }
  .toggle-switch.night { background: rgba(30,50,100,0.4); border-color: rgba(100,150,255,0.3); }
  .toggle-switch.night::after { background: #6488c9; }

  .loading {
    position: fixed;
    inset: 0;
    background: #0a0a0a;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 100;
    transition: opacity 1s;
  }

  .loading.hidden { opacity: 0; pointer-events: none; }

  .loading h2 {
    font-family: 'Playfair Display', serif;
    font-size: 22px;
    margin-bottom: 8px;
    color: #c9a96e;
  }

  .loading p {
    font-size: 11px;
    color: rgba(255,255,255,0.4);
    margin-bottom: 16px;
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  .loading-bar {
    width: 180px;
    height: 2px;
    background: rgba(255,255,255,0.08);
    border-radius: 1px;
    overflow: hidden;
  }

  .loading-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #c9a96e, #e0c48a);
    width: 0%;
    transition: width 0.3s;
  }
</style>
</head>
<body>

<div class="loading" id="loading">
  <h2>625 Ocean Street</h2>
  <p>Satellite Beach, Florida — 3-Story Coastal Residence</p>
  <div class="loading-bar"><div class="loading-bar-fill" id="loadingFill"></div></div>
</div>

<div class="overlay-top">
  <div class="title-block">
    <h1>625 Ocean Street</h1>
    <p>Satellite Beach, FL — 3-Story SFR &bull; EDC Engineering &bull; Sheet A3–A5</p>
  </div>
  <div class="stats">
    <div class="stat">
      <div class="stat-value">1,966</div>
      <div class="stat-label">Level 1 Sq Ft</div>
    </div>
    <div class="stat">
      <div class="stat-value">2,432</div>
      <div class="stat-label">Level 2 Sq Ft</div>
    </div>
    <div class="stat">
      <div class="stat-value">2,725</div>
      <div class="stat-label">Level 3 Sq Ft</div>
    </div>
    <div class="stat">
      <div class="stat-value">7,123</div>
      <div class="stat-label">Total Sq Ft</div>
    </div>
  </div>
</div>

<div class="side-panel">
  <div class="floor-toggle">
    <button class="floor-btn active" onclick="showFloor('all')">All Floors</button>
    <button class="floor-btn" onclick="showFloor(1)">L1 — Rec / Office / Bed</button>
    <button class="floor-btn" onclick="showFloor(2)">L2 — Kitchen / 3 Bed</button>
    <button class="floor-btn" onclick="showFloor(3)">L3 — Balcony / Bar</button>
  </div>
  <div style="margin-top: 12px;">
    <div class="toggle-row">
      <label>Day</label>
      <div class="toggle-switch" id="timeToggle" onclick="toggleTime()"></div>
      <label>Night</label>
    </div>
    <div class="toggle-row">
      <label>Walls</label>
      <div class="toggle-switch on" id="wallToggle" onclick="toggleWalls()"></div>
      <label style="min-width:auto">On</label>
    </div>
    <div class="toggle-row">
      <label>Roof</label>
      <div class="toggle-switch on" id="roofToggle" onclick="toggleRoof()"></div>
      <label style="min-width:auto">On</label>
    </div>
  </div>
</div>

<div class="overlay-bottom">
  <div class="controls-hint">
    <kbd>Left Click</kbd> Orbit &nbsp; <kbd>Scroll</kbd> Zoom &nbsp; <kbd>Right Click</kbd> Pan
  </div>
  <div class="btn-group">
    <button class="view-btn active" onclick="setView('perspective')">Perspective</button>
    <button class="view-btn" onclick="setView('top')">Plan</button>
    <button class="view-btn" onclick="setView('front')">Front</button>
    <button class="view-btn" onclick="setView('side')">Side</button>
    <button class="view-btn" onclick="setView('ocean')">Ocean View</button>
    <button class="view-btn" onclick="setView('walkthrough')">Walkthrough</button>
  </div>
</div>

<div id="canvas-container"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
// ============================================================
// 625 OCEAN STREET — FULL 3-STORY 3D MODEL
// Based on EDC Engineering plans A3 (L1), A4 (L2), A5 (L3)
// ============================================================

const container = document.getElementById('canvas-container');
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1200);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.1;
renderer.outputEncoding = THREE.sRGBEncoding;
container.appendChild(renderer.domElement);

const loadingEl = document.getElementById('loading');
const loadingFill = document.getElementById('loadingFill');
function updateLoading(p) {
  loadingFill.style.width = p + '%';
  if (p >= 100) setTimeout(() => loadingEl.classList.add('hidden'), 500);
}

// ===== MATERIALS =====
function mat(color, r, m, opts) {
  return new THREE.MeshStandardMaterial({
    color, roughness: r ?? 0.7, metalness: m ?? 0, ...opts
  });
}

const M = {
  wallExt: mat(0xf2ede4, 0.85),
  wallInt: mat(0xfaf7f2, 0.9),
  wallExtDark: mat(0xe8e0d0, 0.85),
  floorWood: mat(0xb08550, 0.55),
  floorWoodDark: mat(0x8a6540, 0.55),
  floorTile: mat(0xd0c8b8, 0.35),
  floorTileBath: mat(0xc8c0b0, 0.25),
  floorCarpet: mat(0x888078, 0.95),
  floorConcrete: mat(0xaaaaaa, 0.85),
  floorBalcony: mat(0xc0b8a0, 0.7),
  ceiling: mat(0xfefefe, 0.92),
  trim: mat(0xffffff, 0.4),
  door: mat(0x5a3a1a, 0.45),
  doorExt: mat(0x3a2a12, 0.4),
  glass: mat(0x88ccee, 0.05, 0.1, { transparent: true, opacity: 0.25, side: THREE.DoubleSide }),
  glassTemp: mat(0x99ccdd, 0.08, 0.05, { transparent: true, opacity: 0.2, side: THREE.DoubleSide }),
  counter: mat(0x2a2a2a, 0.2, 0.05),
  counterWhite: mat(0xf0ece4, 0.2, 0.02),
  cabinet: mat(0xeee6d4, 0.6),
  cabinetDark: mat(0x4a3a28, 0.5),
  metal: mat(0xc0c0c0, 0.25, 0.8),
  metalDark: mat(0x555555, 0.3, 0.7),
  appliance: mat(0xe8e8e8, 0.2, 0.5),
  applianceDark: mat(0x333333, 0.15, 0.6),
  grass: mat(0x4a7a30, 0.95),
  concrete: mat(0xc0c0c0, 0.85),
  sand: mat(0xd4c8a0, 0.9),
  ocean: mat(0x2070b0, 0.15, 0.1, { transparent: true, opacity: 0.75 }),
  roof: mat(0x605040, 0.8),
  roofMetal: mat(0x808080, 0.4, 0.6),
  gold: mat(0xc9a96e, 0.35, 0.5),
  cmu: mat(0xb0a898, 0.85),
  wood: mat(0x7a5a35, 0.55),
  woodColumn: mat(0x6a4a28, 0.5),
  sofa: mat(0x505560, 0.85),
  sofaBlue: mat(0x3a4a60, 0.85),
  bed: mat(0xf0e8d8, 0.9),
  bedspread: mat(0x304a6a, 0.85),
  pillow: mat(0xffffff, 0.92),
  fireplace: mat(0x1a1a1a, 0.3, 0.1),
  tv: mat(0x0a0a0a, 0.15, 0.3),
  plant: mat(0x2a6a28, 0.9),
  pot: mat(0x6a4a30, 0.7),
  railing: mat(0xd0d0d0, 0.2, 0.7, { transparent: true, opacity: 0.5 }),
};

updateLoading(10);

// ===== DIMENSIONS =====
// Based on plan scale 1/4" = 1'-0"
// Building footprint roughly 72' long x 26' wide
// Floor heights: ~10' floor-to-floor
const FH = 10; // floor height
const WT = 0.5; // interior wall thickness
const EWT = 0.8; // exterior wall thickness
const BW = 26; // building width (N-S)
const BL = 72; // building length (E-W)

// Building group
const building = new THREE.Group();
scene.add(building);

// Floor groups for visibility toggling
const floors = { 1: new THREE.Group(), 2: new THREE.Group(), 3: new THREE.Group() };
Object.values(floors).forEach(f => building.add(f));

// Shared elements (elevator shaft, stairs, exterior walls)
const shared = new THREE.Group();
building.add(shared);

// ===== HELPERS =====
function box(parent, x, y, z, w, h, d, material) {
  const geo = new THREE.BoxGeometry(w, h, d);
  const mesh = new THREE.Mesh(geo, material);
  mesh.position.set(x, y + h/2, z);
  mesh.castShadow = true;
  mesh.receiveShadow = true;
  parent.add(mesh);
  return mesh;
}

function slab(parent, x, y, z, w, d, material) {
  return box(parent, x, y, z, w, 0.4, d, material);
}

function cyl(parent, x, y, z, r, h, material, seg) {
  const geo = new THREE.CylinderGeometry(r, r, h, seg || 16);
  const mesh = new THREE.Mesh(geo, material);
  mesh.position.set(x, y + h/2, z);
  mesh.castShadow = true;
  parent.add(mesh);
  return mesh;
}

function wallSeg(parent, x, y, z, w, h, d, material) {
  return box(parent, x, y, z, w, h, d, material || M.wallInt);
}

// Window helper
function win(parent, x, y, z, w, h, rotY) {
  const g = new THREE.Group();
  const glass = new THREE.Mesh(new THREE.BoxGeometry(w - 0.2, h - 0.2, 0.06), M.glass);
  g.add(glass);
  // Frame
  const ft = 0.12;
  const fh = new THREE.BoxGeometry(w, ft, ft);
  const fv = new THREE.BoxGeometry(ft, h, ft);
  [h/2 - ft/2, -h/2 + ft/2].forEach(yy => { const m = new THREE.Mesh(fh, M.trim); m.position.y = yy; g.add(m); });
  [w/2 - ft/2, -w/2 + ft/2].forEach(xx => { const m = new THREE.Mesh(fv, M.trim); m.position.x = xx; g.add(m); });
  g.position.set(x, y + h/2, z);
  if (rotY) g.rotation.y = rotY;
  parent.add(g);
  return g;
}

// Transom window
function transom(parent, x, y, z, w, h, rotY) {
  return win(parent, x, y, z, w, h || 2, rotY);
}

// Door helper
function door(parent, x, y, z, w, h, material, rotY) {
  const m = box(parent, x, y, z, w, h || 8, 0.2, material || M.door);
  if (rotY) m.rotation.y = rotY;
  const handle = new THREE.Mesh(new THREE.SphereGeometry(0.12, 8, 8), M.gold);
  handle.position.set(w/3, 0, 0.15);
  m.add(handle);
  return m;
}

updateLoading(20);

// ==============================================================
// LEVEL 1 (A3) — Ground Floor — 1,966 sq ft + 180 sq ft porch
// Base Y = 0
// ==============================================================
const L1 = floors[1];
const L1Y = 0;

// --- Floor slabs ---
// Entry Porch (west end)
slab(L1, -30, L1Y, 0, 8, 12, M.floorTile);
// Entry Foyer
slab(L1, -22, L1Y, 0, 10, 16, M.floorTile);
// Stair area (within foyer, open to above)
// Rec Room
slab(L1, -10, L1Y, -4, 14, 12, M.floorWood);
// Wet Bar area
slab(L1, -10, L1Y, 8, 14, 8, M.floorTile);
// Office
slab(L1, 6, L1Y, -5, 12, 10, M.floorCarpet);
// Bedroom
slab(L1, 8, L1Y, 7, 16, 10, M.floorWood);
// Bathroom
slab(L1, 18, L1Y, -5, 8, 10, M.floorTileBath);
// Laundry
slab(L1, 16, L1Y, 3, 4, 6, M.floorTile);
// WIC
slab(L1, 20, L1Y, 7, 6, 6, M.floorCarpet);
// Mech
slab(L1, 22, L1Y, -2, 4, 4, M.floorConcrete);

// --- Ceilings ---
function addCeiling(parent, x, y, z, w, d) {
  return slab(parent, x, y + FH, z, w, d, M.ceiling);
}
addCeiling(L1, -30, L1Y, 0, 8, 12);
addCeiling(L1, -22, L1Y, 0, 10, 16);
addCeiling(L1, -10, L1Y, 0, 14, 22);
addCeiling(L1, 6, L1Y, -5, 12, 10);
addCeiling(L1, 8, L1Y, 7, 16, 10);
addCeiling(L1, 18, L1Y, -5, 8, 10);

updateLoading(30);

// --- Exterior Walls L1 ---
// South wall (z = -13)
wallSeg(L1, -4, L1Y, -13, 52, FH, EWT, M.wallExt);
// North wall (z = 13)
wallSeg(L1, -4, L1Y, 13, 52, FH, EWT, M.wallExt);
// West wall (x = -34)
wallSeg(L1, -34, L1Y, 0, EWT, FH, BW, M.wallExt);
// East wall (x = 26)
wallSeg(L1, 26, L1Y, 0, EWT, FH, BW, M.wallExt);

// --- Interior Walls L1 ---
// Entry foyer east wall
wallSeg(L1, -17, L1Y, 0, WT, FH, 16);
// Foyer to porch
wallSeg(L1, -26, L1Y, 0, WT, FH, 16);
// Rec Room / Wet Bar divider (z = 0 center)
wallSeg(L1, -10, L1Y, 0, 14, FH, WT);
// Rec/Office divider (x = -3)
// Office south wall
wallSeg(L1, 0, L1Y, -5, WT, FH, 10);
// Bedroom/Office divider
wallSeg(L1, 6, L1Y, 2, WT, FH, 22);
// Bathroom walls
wallSeg(L1, 14, L1Y, -5, WT, FH, 10);
wallSeg(L1, 18, L1Y, 0, 8, FH, WT);
// Laundry walls
wallSeg(L1, 16, L1Y, 6, WT, FH, 6);
wallSeg(L1, 14, L1Y, 3, 4, FH, WT);

// --- Level 1 Furniture ---
// Entry Foyer
cyl(L1, -22, 0.4, -2, 0.5, 0.6, M.pot); // plant pot
const p1 = new THREE.Mesh(new THREE.SphereGeometry(1, 10, 8), M.plant);
p1.position.set(-22, 1.8, -2); L1.add(p1);

// Rec Room: sofa, coffee table, TV, fireplace
box(L1, -13, 0.4, -8, 7, 2.2, 3, M.sofa); // sofa
box(L1, -13, 2.6, -9.5, 7, 1.5, 0.5, M.sofa); // sofa back
box(L1, -10, 0.4, -5, 4, 1.2, 2.2, M.wood); // coffee table
// 72" Linear Electric Fireplace
box(L1, -10, 1.5, -0.5, 6, 2, 0.5, M.fireplace);
box(L1, -10, 1.8, -0.4, 5.5, 1.2, 0.1, mat(0xff4400, 0.5, 0, { emissive: 0xff2200, emissiveIntensity: 0.3 }));
// Pendant light
cyl(L1, -10, 8.5, -4, 0.6, 0.3, M.gold);

// Wet Bar
box(L1, -12, 0.4, 5, 8, 3, 1.5, M.counter); // bar counter 36" ht
box(L1, -12, 0.4, 10, 8, 3, 2, M.cabinet); // cabinets
box(L1, -12, 3.5, 10.5, 8, 2.5, 1, M.cabinet); // upper cabs
// Bar stools
for (let i = 0; i < 3; i++) {
  cyl(L1, -14 + i * 2.5, 0.4, 3.5, 0.35, 2, M.metal);
  box(L1, -14 + i * 2.5, 2.4, 3.5, 0.8, 0.12, 0.8, M.wood);
}
cyl(L1, -6, 8.5, 8, 0.5, 0.25, M.gold); // pendant

// Office
box(L1, 3, 0.4, -8, 5, 2.5, 2.5, M.wood); // desk
box(L1, 3, 0.4, -5.5, 1.8, 1.5, 1.8, M.metalDark); // chair
box(L1, 3, 1.9, -4.8, 1.8, 1.8, 0.4, M.metalDark); // chair back
box(L1, -0.5, 0.4, -9, 1.2, 7, 5, M.cabinetDark); // bookshelf

// Bedroom
box(L1, 10, 0.4, 7, 6, 1.5, 7, M.bed); // mattress
box(L1, 10, 0.4, 11.5, 6, 3.2, 0.5, M.cabinetDark); // headboard
box(L1, 9, 1.9, 10, 2, 0.5, 1.5, M.pillow);
box(L1, 11, 1.9, 10, 2, 0.5, 1.5, M.pillow);
box(L1, 10, 1.8, 5, 5.5, 0.3, 4, M.bedspread);
box(L1, 7, 0.4, 11, 1.5, 1.5, 1.5, M.cabinetDark); // nightstand
box(L1, 13, 0.4, 11, 1.5, 1.5, 1.5, M.cabinetDark); // nightstand
cyl(L1, 7, 1.9, 11, 0.15, 1.5, M.gold); // lamp
cyl(L1, 13, 1.9, 11, 0.15, 1.5, M.gold); // lamp
// Built-in niche shelf
box(L1, 6.5, 3, 7, 0.5, 4, 8, M.cabinet);
// Soffit line
box(L1, 10, 9, 7, 14, 1, 10, M.ceiling);

// Bathroom
box(L1, 16, 0.4, -8, 1.5, 1.5, 2, M.appliance); // toilet
box(L1, 20, 0.4, -8, 3, 2.8, 2, M.cabinet); // vanity
box(L1, 20, 2.8, -8, 3, 0.2, 2, M.counterWhite); // countertop
// 32x72 freestanding tub
box(L1, 16, 0.4, -3, 2.7, 2, 6, M.appliance);
// Walk-in shower
box(L1, 20, 0.4, -3, 3, 0.3, 4, M.floorTileBath);
// Tempered glass
box(L1, 18.5, 0.4, -3, 0.1, 7, 4, M.glassTemp);

// Laundry
box(L1, 15, 0.4, 3, 2.2, 3, 2.2, M.appliance); // washer
box(L1, 17.2, 0.4, 3, 2.2, 3, 2.2, M.appliance); // dryer

// Staircase UP 26R
const stairGroup1 = new THREE.Group();
for (let i = 0; i < 26; i++) {
  const step = box(stairGroup1, 0, i * (FH / 26), -6 + (i / 26) * 12, 4, 0.3, 0.5, M.floorWood);
}
// Glass rail
box(stairGroup1, -2.2, 0, 0, 0.08, FH, 12, M.railing);
box(stairGroup1, 2.2, 0, 0, 0.08, FH, 12, M.railing);
stairGroup1.position.set(-22, 0.4, 0);
shared.add(stairGroup1);

// Future Elevator shaft
box(shared, -30, 0, 6, 5, FH * 3 + 2, 5, mat(0x888888, 0.7, 0.2, { transparent: true, opacity: 0.15 }));
box(shared, -30, 0, 6, 4.5, 0.1, 4.5, M.metal); // elevator floor

updateLoading(45);

// ==============================================================
// LEVEL 2 (A4) — Second Floor — 2,432 sq ft
// Base Y = FH (10)
// ==============================================================
const L2 = floors[2];
const L2Y = FH;

// Floor slabs L2
slab(L2, -22, L2Y, 0, 10, 16, M.floorTile); // Foyer/stairs
slab(L2, -10, L2Y, -4, 14, 12, M.floorWood); // Kitchen
slab(L2, -10, L2Y, 8, 14, 8, M.floorTile); // Laundry/Bar
slab(L2, 6, L2Y, -5, 12, 10, M.floorWoodDark); // Bedroom 1
slab(L2, 8, L2Y, 7, 16, 10, M.floorWoodDark); // Bedroom 2
slab(L2, 18, L2Y, -5, 8, 10, M.floorTileBath); // Bath
slab(L2, 20, L2Y, 0, 6, 6, M.floorWoodDark); // Bedroom 3

// Ceilings L2
addCeiling(L2, -22, L2Y, 0, 10, 16);
addCeiling(L2, -10, L2Y, 0, 14, 22);
addCeiling(L2, 6, L2Y, -5, 12, 10);
addCeiling(L2, 8, L2Y, 7, 16, 10);
addCeiling(L2, 18, L2Y, -5, 8, 10);

// Exterior Walls L2
wallSeg(L2, -4, L2Y, -13, 52, FH, EWT, M.wallExt);
wallSeg(L2, -4, L2Y, 13, 52, FH, EWT, M.wallExt);
wallSeg(L2, -34, L2Y, 0, EWT, FH, BW, M.wallExt);
wallSeg(L2, 26, L2Y, 0, EWT, FH, BW, M.wallExt);

// Interior Walls L2
wallSeg(L2, -17, L2Y, 0, WT, FH, 16);
wallSeg(L2, -10, L2Y, 0, 14, FH, WT);
wallSeg(L2, 0, L2Y, -5, WT, FH, 10);
wallSeg(L2, 6, L2Y, 2, WT, FH, 22);
wallSeg(L2, 14, L2Y, -5, WT, FH, 10);
wallSeg(L2, 18, L2Y, 0, 8, FH, WT);
wallSeg(L2, 16, L2Y, 3, WT, FH, 6);

// Kitchen furniture
box(L2, -14, L2Y + 0.4, -8, 10, 3, 2, M.cabinet); // base cabinets
box(L2, -14, L2Y + 3.5, -8.5, 10, 0.2, 2.5, M.counter); // countertop
box(L2, -14, L2Y + 4, -8.5, 10, 2.8, 1, M.cabinet); // upper cabinets
box(L2, -6, L2Y + 0.4, -8, 2, 6, 2, M.appliance); // 48" ref
box(L2, -16, L2Y + 0.4, -5, 3, 3, 2.5, M.applianceDark); // range/oven
box(L2, -16, L2Y + 3.5, -5, 3.5, 1.5, 1, M.metal); // exhaust hood
box(L2, -8, L2Y + 0.4, -5, 2, 5.5, 2, M.applianceDark); // wall ovens
box(L2, -14, L2Y + 0.4, -3, 4, 3, 1.5, M.counter); // island
// 48" pantry
box(L2, -17, L2Y + 0.4, -2, 2, 8, 3, M.cabinet);
// Coffee bar
box(L2, -7, L2Y + 0.4, -2, 3, 3, 1.5, M.cabinetDark);
// DW
box(L2, -12, L2Y + 0.4, -7.5, 2, 2.8, 2, M.metal);

// Bar / Wine Tower
box(L2, -12, L2Y + 0.4, 5, 6, 3, 1.5, M.counter); // bar counter
box(L2, -14, L2Y + 0.4, 10, 2, 7, 2, M.cabinetDark); // wine tower
box(L2, -8, L2Y + 0.4, 10, 6, 3, 2, M.cabinet); // bar cabinets
// Gas BBQ Grille
box(L2, -6, L2Y + 0.4, 11, 2.5, 3, 2, M.metal);

// 72" Fireplaces (x2)
box(L2, -10, L2Y + 1.5, -0.5, 6, 2, 0.5, M.fireplace);
box(L2, -10, L2Y + 1.8, -0.4, 5.5, 1.2, 0.1, mat(0xff4400, 0.5, 0, { emissive: 0xff2200, emissiveIntensity: 0.3 }));
box(L2, 8, L2Y + 1.5, 12.5, 6, 2, 0.5, M.fireplace);
box(L2, 8, L2Y + 1.8, 12.4, 5.5, 1.2, 0.1, mat(0xff4400, 0.5, 0, { emissive: 0xff2200, emissiveIntensity: 0.3 }));

// Bedrooms L2
// Bedroom 1 (east, south side)
box(L2, 3, L2Y + 0.4, -8, 5.5, 1.5, 6.5, M.bed);
box(L2, 3, L2Y + 0.4, -11, 5.5, 3, 0.5, M.cabinetDark);
box(L2, 2, L2Y + 1.9, -10, 2, 0.5, 1.5, M.pillow);
box(L2, 4, L2Y + 1.9, -10, 2, 0.5, 1.5, M.pillow);
box(L2, 3, L2Y + 1.8, -6, 5, 0.3, 3.5, M.bedspread);

// Bedroom 2 (north side, large)
box(L2, 10, L2Y + 0.4, 8, 6, 1.5, 7, M.bed);
box(L2, 10, L2Y + 0.4, 12, 6, 3.2, 0.5, M.cabinetDark);
box(L2, 9, L2Y + 1.9, 11, 2, 0.5, 1.5, M.pillow);
box(L2, 11, L2Y + 1.9, 11, 2, 0.5, 1.5, M.pillow);
box(L2, 10, L2Y + 1.8, 6, 5.5, 0.3, 4, M.bedspread);
box(L2, 10, L2Y + 9, 7, 14, 1, 10, M.ceiling); // soffit

// Bedroom 3 (smaller, middle)
box(L2, 20, L2Y + 0.4, 1, 4.5, 1.5, 5.5, M.bed);
box(L2, 20, L2Y + 1.9, -1, 2, 0.5, 1, M.pillow);

// Bathroom L2
box(L2, 16, L2Y + 0.4, -8, 2.7, 2, 6, M.appliance); // tub
box(L2, 20, L2Y + 0.4, -3, 3, 0.3, 4, M.floorTileBath); // shower base
box(L2, 18.5, L2Y + 0.4, -3, 0.1, 7, 4, M.glassTemp); // glass
box(L2, 20, L2Y + 0.4, -8, 3, 2.8, 2, M.cabinet); // vanity

// Laundry L2
box(L2, -4, L2Y + 0.4, 10, 2.2, 3, 2.2, M.appliance);
box(L2, -2, L2Y + 0.4, 10, 2.2, 3, 2.2, M.appliance);

// Staircase DN 26R / UP 20R
const stairGroup2 = new THREE.Group();
for (let i = 0; i < 20; i++) {
  box(stairGroup2, 0, i * (FH / 20), -6 + (i / 20) * 12, 4, 0.3, 0.6, M.floorWood);
}
stairGroup2.position.set(-22, L2Y + 0.4, 0);
shared.add(stairGroup2);

updateLoading(60);

// ==============================================================
// LEVEL 3 (A5) — Roof/Balcony Level
// Open Balcony 1,913 sq ft + Upper Foyer 364 sq ft + Covered Porch 448 sq ft
// Base Y = FH * 2 (20)
// ==============================================================
const L3 = floors[3];
const L3Y = FH * 2;

// Main balcony deck
slab(L3, -4, L3Y, 0, 52, BW, M.floorBalcony);

// Upper level foyer
slab(L3, -22, L3Y, 0, 10, 16, M.floorTile);
addCeiling(L3, -22, L3Y, 0, 10, 16);
// Foyer walls
wallSeg(L3, -17, L3Y, 0, WT, FH, 16);
wallSeg(L3, -26, L3Y, 0, WT, FH, 16);
wallSeg(L3, -22, L3Y, -8, 8, FH, WT, M.wallExt);
wallSeg(L3, -22, L3Y, 8, 8, FH, WT, M.wallExt);

// Covered porch structure (east end)
// 8x8 wood columns
const porchX = 16;
for (let xi = 0; xi < 3; xi++) {
  for (let zi = -1; zi <= 1; zi += 2) {
    box(L3, porchX + xi * 8, L3Y + 0.4, zi * 10, 0.67, 9, 0.67, M.woodColumn);
  }
}
// Porch roof
slab(L3, porchX + 8, L3Y + FH, 0, 24, 22, M.roof);
// Wood headers
box(L3, porchX + 8, L3Y + 9, -10, 24, 0.8, 0.67, M.wood);
box(L3, porchX + 8, L3Y + 9, 10, 24, 0.8, 0.67, M.wood);

// 48" CMU walls on balcony
box(L3, 4, L3Y + 0.4, -13, 20, 4, EWT, M.cmu);
box(L3, 4, L3Y + 0.4, 13, 20, 4, EWT, M.cmu);

// Metal/glass railing around open balcony
box(L3, -10, L3Y + 0.4, -13, 20, 3.5, 0.15, M.railing);
box(L3, -10, L3Y + 0.4, 13, 20, 3.5, 0.15, M.railing);
box(L3, 26, L3Y + 0.4, 0, 0.15, 3.5, BW, M.railing);

// Summer Kitchen area
box(L3, 10, L3Y + 0.4, 8, 6, 3, 1.5, M.counter); // bar counter
box(L3, 10, L3Y + 0.4, 11, 6, 3, 2, M.cabinet); // cabinets
box(L3, 14, L3Y + 0.4, 11, 2.5, 3, 2, M.metal); // BBQ grille
box(L3, 7, L3Y + 0.4, 11, 2, 2.8, 2, M.appliance); // UC ref
box(L3, 5, L3Y + 0.4, 11, 1.5, 2.8, 2, M.appliance); // UC ice maker

// Wet Bar areas (x2)
box(L3, 2, L3Y + 0.4, -8, 5, 3, 1.5, M.counter);
box(L3, 2, L3Y + 0.4, -11, 5, 3, 2, M.cabinet);
box(L3, -6, L3Y + 0.4, -8, 5, 3, 1.5, M.counter);
box(L3, -6, L3Y + 0.4, -11, 5, 3, 2, M.cabinet);

// Outdoor TV equipment
box(L3, 20, L3Y + 2, -8, 5, 3, 0.15, M.tv);
box(L3, 20, L3Y + 0.4, -9, 5, 1.8, 1.5, M.cabinetDark); // media cabinet

// Storage
box(L3, -12, L3Y + 0.4, 8, 6, 7, 6, M.wallExt); // enclosed storage

// 3/0 x 8/0 Ext doors with sidelights (L3 foyer to balcony)
door(L3, -17, L3Y + 0.4, -4, 3, 8, M.doorExt);
door(L3, -17, L3Y + 0.4, 4, 3, 8, M.doorExt);

// Fixed glass windows L3 foyer
win(L3, -22, L3Y + 2, -8.2, 3, 4);
win(L3, -22, L3Y + 2, 8.2, 3, 4);

// Outdoor seating
box(L3, 0, L3Y + 0.4, 2, 6, 1.2, 3, M.sofaBlue);
box(L3, 0, L3Y + 1.6, 3.3, 6, 0.8, 0.4, M.sofaBlue);
box(L3, 8, L3Y + 0.4, -2, 3, 1.2, 3, M.sofaBlue);
// Table
box(L3, 4, L3Y + 0.4, -2, 3, 1, 3, M.wood);

updateLoading(70);

// ==============================================================
// WINDOWS — All Levels
// ==============================================================

// L1 Windows
win(L1, -10, L1Y + 3, -13.2, 4, 6); // Rec room south
win(L1, -10, L1Y + 3, 13.2, 4, 6); // Wet bar north  
win(L1, 6, L1Y + 3, -13.2, 4, 6); // Office south
win(L1, 8, L1Y + 3, 13.2, 4, 6); // Bedroom north
win(L1, 18, L1Y + 3, -13.2, 2, 4); // Bath south
transom(L1, -10, L1Y + 7.5, -13.2, 6, 2); // Rec transom
transom(L1, 8, L1Y + 7.5, 13.2, 6, 2); // Bedroom transom
win(L1, 26.2, L1Y + 3, 7, 5, 5, Math.PI/2); // Bedroom east
win(L1, 26.2, L1Y + 3, -5, 3, 4, Math.PI/2); // Bath east

// L2 Windows  
win(L2, -10, L2Y + 3, -13.2, 4, 6);
win(L2, -10, L2Y + 3, 13.2, 4, 6);
win(L2, 6, L2Y + 3, -13.2, 4, 6);
win(L2, 8, L2Y + 3, 13.2, 4, 6);
win(L2, 18, L2Y + 3, -13.2, 2, 4);
win(L2, -4, L2Y + 3, -13.2, 4, 6); // Kitchen south
transom(L2, -10, L2Y + 7.5, -13.2, 6, 2);
transom(L2, 8, L2Y + 7.5, 13.2, 6, 2);
win(L2, 26.2, L2Y + 3, 7, 5, 5, Math.PI/2);
win(L2, 26.2, L2Y + 3, -5, 3, 4, Math.PI/2);
// 4/0 x 6/0 casement windows (egress)
win(L2, 3, L2Y + 2, -13.2, 4, 6); // Bdrm1 egress
win(L2, 20, L2Y + 2, 13.2, 4, 6); // Bdrm2 egress
// 4/0 x 6/0 fixed window units
win(L2, -20, L2Y + 2, -13.2, 4, 6);
win(L2, -16, L2Y + 2, -13.2, 4, 6);

// L3 Windows on covered porch
for (let i = 0; i < 4; i++) {
  win(L3, porchX + 2 + i * 5, L3Y + 3, -13.2, 3, 4);
  win(L3, porchX + 2 + i * 5, L3Y + 3, 13.2, 3, 4);
}

updateLoading(78);

// ==============================================================
// ROOF
// ==============================================================
const roofGroup = new THREE.Group();
roofGroup.name = 'roof';

// Main flat/low-slope roof over L3 covered porch area
box(roofGroup, -4, L3Y + FH + 0.5, 0, 52, 0.5, BW + 4, M.roofMetal);

// Slight pitched section over foyer
const roofGeo = new THREE.BoxGeometry(12, 0.4, 18);
const roofPiece = new THREE.Mesh(roofGeo, M.roof);
roofPiece.position.set(-22, L3Y + FH + 2, 0);
roofPiece.rotation.z = 0.1;
roofGroup.add(roofPiece);

// Parapet walls
box(roofGroup, -4, L3Y + FH, -13.5, 52, 2, 0.5, M.wallExtDark);
box(roofGroup, -4, L3Y + FH, 13.5, 52, 2, 0.5, M.wallExtDark);
box(roofGroup, -34, L3Y + FH, 0, 0.5, 2, BW + 1, M.wallExtDark);
box(roofGroup, 26.5, L3Y + FH, 0, 0.5, 2, BW + 1, M.wallExtDark);

building.add(roofGroup);

updateLoading(82);

// ==============================================================
// EXTERIOR ENVIRONMENT
// ==============================================================

// Ground
const groundGeo = new THREE.PlaneGeometry(400, 400);
const ground = new THREE.Mesh(groundGeo, M.grass);
ground.rotation.x = -Math.PI / 2;
ground.receiveShadow = true;
scene.add(ground);

// Ocean (east side — it's Ocean Street!)
const oceanGeo = new THREE.PlaneGeometry(200, 400);
const ocean = new THREE.Mesh(oceanGeo, M.ocean);
ocean.rotation.x = -Math.PI / 2;
ocean.position.set(130, -0.3, 0);
ocean.receiveShadow = true;
scene.add(ocean);

// Beach/sand
const sandGeo = new THREE.PlaneGeometry(40, 60);
const sandMesh = new THREE.Mesh(sandGeo, M.sand);
sandMesh.rotation.x = -Math.PI / 2;
sandMesh.position.set(50, 0.02, 0);
scene.add(sandMesh);

// Driveway
box(scene, -34, 0, -20, 16, 0.08, 10, M.concrete);
box(scene, -28, 0, -28, 8, 0.08, 12, M.concrete);

// Entry path
box(scene, -30, 0, -16, 4, 0.08, 6, M.concrete);

// Street
box(scene, -4, -0.05, -35, 80, 0.1, 12, mat(0x444444, 0.9));
// Sidewalk
box(scene, -4, 0, -28, 80, 0.08, 3, M.concrete);

// Palm trees (Florida coastal)
function addPalm(x, z, h) {
  h = h || 18;
  // Trunk - slightly curved
  const trunkSegs = 8;
  for (let i = 0; i < trunkSegs; i++) {
    const ty = (i / trunkSegs) * h;
    const sway = Math.sin(i / trunkSegs * 1.5) * 1.5;
    cyl(scene, x + sway * 0.5, ty, z, 0.35 - i * 0.02, h / trunkSegs, mat(0x7a6a50, 0.8));
  }
  // Fronds
  const frondCount = 7;
  for (let i = 0; i < frondCount; i++) {
    const angle = (i / frondCount) * Math.PI * 2;
    const frondGeo = new THREE.BoxGeometry(0.4, 0.1, 5);
    const frond = new THREE.Mesh(frondGeo, M.plant);
    frond.position.set(x + Math.cos(angle) * 2, h - 0.5, z + Math.sin(angle) * 2);
    frond.rotation.y = angle;
    frond.rotation.x = 0.4;
    scene.add(frond);
  }
  // Top cluster
  const top = new THREE.Mesh(new THREE.SphereGeometry(2, 8, 6), M.plant);
  top.position.set(x, h + 0.5, z);
  top.scale.y = 0.6;
  scene.add(top);
}

addPalm(-40, 15, 20);
addPalm(-38, -20, 18);
addPalm(35, 12, 22);
addPalm(38, -8, 19);
addPalm(45, 5, 21);
addPalm(-15, 20, 17);
addPalm(10, -22, 16);

// Landscaping bushes
for (let i = -34; i <= 24; i += 3) {
  const bush = new THREE.Mesh(
    new THREE.SphereGeometry(1 + Math.random() * 0.5, 8, 6),
    mat(0x2a5a2a + Math.floor(Math.random() * 0x0a1a0a), 0.95)
  );
  bush.position.set(i, 1, 15);
  bush.scale.y = 0.7;
  bush.castShadow = true;
  scene.add(bush);
}

updateLoading(90);

// ==============================================================
// LIGHTING
// ==============================================================
const ambient = new THREE.AmbientLight(0xffffff, 0.3);
scene.add(ambient);

const sun = new THREE.DirectionalLight(0xfff5e0, 1.3);
sun.position.set(40, 50, 25);
sun.castShadow = true;
sun.shadow.mapSize.set(4096, 4096);
sun.shadow.camera.near = 0.5;
sun.shadow.camera.far = 200;
sun.shadow.camera.left = -60;
sun.shadow.camera.right = 60;
sun.shadow.camera.top = 60;
sun.shadow.camera.bottom = -60;
sun.shadow.bias = -0.0002;
scene.add(sun);

const hemi = new THREE.HemisphereLight(0x87ceeb, 0x4a7a30, 0.25);
scene.add(hemi);

// Interior lights per floor
const iLights = [];
function addILight(parent, x, y, z, intensity, color) {
  const l = new THREE.PointLight(color || 0xfff0d0, intensity, 25);
  l.position.set(x, y, z);
  parent.add(l);
  iLights.push(l);
  return l;
}

// L1 lights
addILight(L1, -22, L1Y + 9, 0, 0.6);
addILight(L1, -10, L1Y + 9, -4, 0.6);
addILight(L1, -10, L1Y + 9, 8, 0.5);
addILight(L1, 6, L1Y + 9, -5, 0.5);
addILight(L1, 10, L1Y + 9, 7, 0.5);
addILight(L1, 18, L1Y + 9, -5, 0.4);

// L2 lights
addILight(L2, -22, L2Y + 9, 0, 0.6);
addILight(L2, -10, L2Y + 9, -4, 0.7);
addILight(L2, -10, L2Y + 9, 8, 0.5);
addILight(L2, 6, L2Y + 9, -5, 0.5);
addILight(L2, 10, L2Y + 9, 7, 0.5);

// L3 lights
addILight(L3, -22, L3Y + 9, 0, 0.6);
addILight(L3, 10, L3Y + 4, 0, 0.4, 0xffe8c0);
addILight(L3, 20, L3Y + 4, 0, 0.4, 0xffe8c0);

// Sky
scene.background = new THREE.Color(0x7ec8e3);
scene.fog = new THREE.Fog(0x7ec8e3, 100, 300);

updateLoading(95);

// ==============================================================
// CAMERA CONTROLS (custom orbit)
// ==============================================================
let isMouseDown = false, isRightDown = false;
let mouseX = 0, mouseY = 0;
let targetRotX = -0.4, targetRotY = 0.65;
let currentRotX = -0.4, currentRotY = 0.65;
let targetDist = 75, currentDist = 75;
let panX = -4, panZ = 0;
let targetPanX = -4, targetPanZ = 0;
let targetPanY = 10, panY = 10;
const cameraTarget = new THREE.Vector3();

const cv = renderer.domElement;
cv.addEventListener('mousedown', e => {
  if (e.button === 0) { isMouseDown = true; mouseX = e.clientX; mouseY = e.clientY; }
  if (e.button === 2) { isRightDown = true; mouseX = e.clientX; mouseY = e.clientY; }
});
cv.addEventListener('mouseup', e => {
  if (e.button === 0) isMouseDown = false;
  if (e.button === 2) isRightDown = false;
});
cv.addEventListener('mousemove', e => {
  const dx = e.clientX - mouseX, dy = e.clientY - mouseY;
  mouseX = e.clientX; mouseY = e.clientY;
  if (isMouseDown) {
    targetRotX -= dx * 0.004;
    targetRotY = Math.max(0.05, Math.min(1.5, targetRotY - dy * 0.004));
  }
  if (isRightDown) {
    const s = currentDist * 0.0015;
    targetPanX += dx * Math.cos(currentRotX) * s;
    targetPanZ -= dx * Math.sin(currentRotX) * s;
    targetPanY += dy * s;
  }
});
cv.addEventListener('wheel', e => {
  e.preventDefault();
  targetDist = Math.max(12, Math.min(180, targetDist + e.deltaY * 0.06));
}, { passive: false });
cv.addEventListener('contextmenu', e => e.preventDefault());

// Touch
cv.addEventListener('touchstart', e => {
  if (e.touches.length === 1) { isMouseDown = true; mouseX = e.touches[0].clientX; mouseY = e.touches[0].clientY; }
});
cv.addEventListener('touchmove', e => {
  e.preventDefault();
  if (e.touches.length === 1 && isMouseDown) {
    const dx = e.touches[0].clientX - mouseX, dy = e.touches[0].clientY - mouseY;
    mouseX = e.touches[0].clientX; mouseY = e.touches[0].clientY;
    targetRotX -= dx * 0.004;
    targetRotY = Math.max(0.05, Math.min(1.5, targetRotY - dy * 0.004));
  }
}, { passive: false });
cv.addEventListener('touchend', () => { isMouseDown = false; });

// ==============================================================
// VIEW PRESETS
// ==============================================================
let walkthroughActive = false, wtTime = 0;

function setView(view) {
  walkthroughActive = false;
  document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
  if (event && event.target) event.target.classList.add('active');

  switch(view) {
    case 'perspective':
      targetRotX = -0.4; targetRotY = 0.65; targetDist = 75;
      targetPanX = -4; targetPanZ = 0; targetPanY = 10;
      break;
    case 'top':
      targetRotX = 0; targetRotY = 0.02; targetDist = 85;
      targetPanX = -4; targetPanZ = 0; targetPanY = 15;
      break;
    case 'front':
      targetRotX = 0; targetRotY = 0.25; targetDist = 70;
      targetPanX = -4; targetPanZ = -30; targetPanY = 12;
      break;
    case 'side':
      targetRotX = Math.PI / 2; targetRotY = 0.3; targetDist = 65;
      targetPanX = -4; targetPanZ = 0; targetPanY = 12;
      break;
    case 'ocean':
      targetRotX = -Math.PI; targetRotY = 0.35; targetDist = 80;
      targetPanX = 10; targetPanZ = 15; targetPanY = 15;
      break;
    case 'walkthrough':
      walkthroughActive = true; wtTime = 0;
      targetDist = 14; targetRotY = 0.45;
      break;
  }
}

// ==============================================================
// FLOOR VISIBILITY
// ==============================================================
let activeFloor = 'all';
function showFloor(f) {
  activeFloor = f;
  document.querySelectorAll('.floor-btn').forEach(b => b.classList.remove('active'));
  if (event && event.target) event.target.classList.add('active');

  if (f === 'all') {
    floors[1].visible = true; floors[2].visible = true; floors[3].visible = true;
    roofGroup.visible = true;
  } else {
    floors[1].visible = (f === 1);
    floors[2].visible = (f === 2);
    floors[3].visible = (f === 3);
    roofGroup.visible = (f === 3);
  }
}

// ==============================================================
// TOGGLES
// ==============================================================
let isNight = false, wallsVisible = true, roofVisible = true;

function toggleTime() {
  isNight = !isNight;
  document.getElementById('timeToggle').classList.toggle('night', isNight);
}

function toggleWalls() {
  wallsVisible = !wallsVisible;
  document.getElementById('wallToggle').classList.toggle('on', wallsVisible);
  // Toggle exterior wall opacity
  building.traverse(child => {
    if (child.material === M.wallExt || child.material === M.wallExtDark) {
      child.visible = wallsVisible;
    }
  });
}

function toggleRoof() {
  roofVisible = !roofVisible;
  document.getElementById('roofToggle').classList.toggle('on', roofVisible);
  roofGroup.visible = roofVisible && (activeFloor === 'all' || activeFloor === 3);
}

// ==============================================================
// ANIMATION LOOP
// ==============================================================
const clock = new THREE.Clock();

function animate() {
  requestAnimationFrame(animate);
  const dt = clock.getDelta();
  const t = clock.getElapsedTime();

  const lerp = 0.05;
  currentRotX += (targetRotX - currentRotX) * lerp;
  currentRotY += (targetRotY - currentRotY) * lerp;
  currentDist += (targetDist - currentDist) * lerp;
  panX += (targetPanX - panX) * lerp;
  panZ += (targetPanZ - panZ) * lerp;
  panY += (targetPanY - panY) * lerp;

  // Walkthrough
  if (walkthroughActive) {
    wtTime += dt * 0.12;
    const path = [
      { x: -30, z: -18, y: 2 },  // approach
      { x: -30, z: 0, y: 2 },    // entry porch
      { x: -22, z: 0, y: 2 },    // foyer
      { x: -10, z: -4, y: 2 },   // rec room
      { x: -10, z: 8, y: 2 },    // wet bar
      { x: 6, z: -5, y: 2 },     // office
      { x: 10, z: 7, y: 2 },     // bedroom
      { x: -22, z: 0, y: 12 },   // up to L2
      { x: -10, z: -4, y: 12 },  // kitchen
      { x: 10, z: 7, y: 12 },    // master bed
      { x: -22, z: 0, y: 22 },   // up to L3
      { x: 0, z: 0, y: 22 },     // balcony
      { x: 20, z: 0, y: 22 },    // covered porch
    ];
    const tt = wtTime % path.length;
    const idx = Math.floor(tt);
    const frac = tt - idx;
    const a = path[idx % path.length];
    const b = path[(idx + 1) % path.length];
    targetPanX = a.x + (b.x - a.x) * frac;
    targetPanZ = a.z + (b.z - a.z) * frac;
    targetPanY = a.y + (b.y - a.y) * frac;
    targetRotX = Math.atan2(b.z - a.z, b.x - a.x) + Math.PI;
  }

  // Day/Night
  const bgDay = new THREE.Color(0x7ec8e3);
  const bgNight = new THREE.Color(0x06101f);
  scene.background.lerp(isNight ? bgNight : bgDay, 0.02);
  scene.fog.color.copy(scene.background);
  sun.intensity = THREE.MathUtils.lerp(sun.intensity, isNight ? 0.03 : 1.3, 0.02);
  ambient.intensity = THREE.MathUtils.lerp(ambient.intensity, isNight ? 0.06 : 0.3, 0.02);
  hemi.intensity = THREE.MathUtils.lerp(hemi.intensity, isNight ? 0.03 : 0.25, 0.02);
  iLights.forEach(l => { l.intensity = THREE.MathUtils.lerp(l.intensity, isNight ? 2 : 0.5, 0.02); });

  // Ocean shimmer
  if (ocean) ocean.material.opacity = 0.6 + Math.sin(t * 1.5) * 0.1;

  // Camera
  cameraTarget.set(panX, panY, panZ);
  camera.position.set(
    panX + currentDist * Math.sin(currentRotX) * Math.cos(currentRotY),
    panY + currentDist * Math.sin(currentRotY),
    panZ + currentDist * Math.cos(currentRotX) * Math.cos(currentRotY)
  );
  camera.lookAt(cameraTarget);

  renderer.render(scene, camera);
}

window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});

updateLoading(100);
animate();
</script>
</body>
</html>
